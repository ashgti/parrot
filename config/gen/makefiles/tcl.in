RM_F    = ${rm_f}
PERL    = ${perl}
PARROT  = ..${slash}..${slash}parrot${exe}
LIBPATH  = lib
BUILD   = $(PERL) ${build_dir}${slash}build_tools${slash}build_dynclasses.pl
DESTDIR = ${build_dir}${slash}runtime${slash}parrot${slash}dynext
O       = ${o}
CLASSDIR = classes
LOAD_EXT = ${load_ext}

PMCS = \
 tclobject \
 tclstring \
 tclint \
 tclfloat \
 tcllist \
 tclarray \
 tclparser

DEPS = $(PARROT) \
lib${slash}commands${slash}append.imc \
lib${slash}commands${slash}array.imc \
lib${slash}commands${slash}break.imc \
lib${slash}commands${slash}catch.imc \
lib${slash}commands${slash}concat.imc \
lib${slash}commands${slash}continue.imc \
lib${slash}commands${slash}error.imc \
lib${slash}commands${slash}eval.imc \
lib${slash}commands${slash}exit.imc \
lib${slash}commands${slash}expr.imc \
lib${slash}commands${slash}for.imc \
lib${slash}commands${slash}foreach.imc \
lib${slash}commands${slash}format.imc \
lib${slash}commands${slash}global.imc \
lib${slash}commands${slash}if.imc \
lib${slash}commands${slash}incr.imc \
lib${slash}commands${slash}info.imc \
lib${slash}commands${slash}inline.imc \
lib${slash}commands${slash}join.imc \
lib${slash}commands${slash}lappend.imc \
lib${slash}commands${slash}lindex.pir \
lib${slash}commands${slash}linsert.imc \
lib${slash}commands${slash}list.imc \
lib${slash}commands${slash}llength.imc \
lib${slash}commands${slash}lrange.imc \
lib${slash}commands${slash}lrepeat.imc \
lib${slash}commands${slash}namespace.imc \
lib${slash}commands${slash}open.imc \
lib${slash}commands${slash}proc.imc \
lib${slash}commands${slash}puts.imc \
lib${slash}commands${slash}rename.imc \
lib${slash}commands${slash}return.imc \
lib${slash}commands${slash}set.imc \
lib${slash}commands${slash}source.imc \
lib${slash}commands${slash}string.imc \
lib${slash}commands${slash}time.imc \
lib${slash}commands${slash}unknown.imc \
lib${slash}commands${slash}unset.imc \
lib${slash}commands${slash}uplevel.imc \
lib${slash}commands${slash}upvar.imc \
lib${slash}commands${slash}while.imc \
lib${slash}conversions.pir \
lib${slash}expression.imc \
lib${slash}get_var.imc \
lib${slash}interpret.imc \
lib${slash}list.imc \
lib${slash}macros${slash}is_space.imc \
lib${slash}string_to_list.imc \
lib${slash}tcl.p6r \
lib${slash}variables.pir \
tcl.imc_template \
tcl.pl

tcl.pbc: pmcs lib${slash}tcllib.pbc lib${slash}tclword.pbc tcl.imc
	$(PARROT) --output=tcl.pbc tcl.imc

pmcs:
	@cd $(CLASSDIR) && $(BUILD) generate $(PMCS)
	@cd $(CLASSDIR) && $(BUILD) compile $(PMCS)
	@cd $(CLASSDIR) && $(BUILD) linklibs $(PMCS)
	@cd $(CLASSDIR) && $(BUILD) copy "--destination=$(DESTDIR)" $(PMCS)

lib${slash}tcllib.imc: $(DEPS)
	$(PERL) tcl.pl > lib${slash}tcllib.imc

lib${slash}tcllib.pbc: lib${slash}tcllib.imc
	$(PARROT) --output=$(LIBPATH)${slash}tcllib.pbc $(LIBPATH)${slash}tcllib.imc

lib${slash}tclword.pbc: lib${slash}tclword.imc
	$(PARROT) --output=$(LIBPATH)${slash}tclword.pbc $(LIBPATH)${slash}tclword.imc

tclsh: tcl.pbc
	$(PARROT) --gc-debug tcl.pbc

test:	tcl.pbc
	$(PERL) t/harness

tcl-test: t-tcl
	$(PERL) t/harness t-tcl/*.t

t-tcl:
	$(PERL) tcl-test.pl

devtest:
	cd t && $(PERL) -e 'use Test::Harness qw($$verbose runtests) ; $$Test::Harness::verbose=1;runtests(glob("*.t"))' && cd ..

clean:
	$(RM_F) lib${slash}tcllib.imc tcl.pbc lib${slash}*.pbc $(CLASSDIR)${slash}pmc_*.h $(CLASSDIR)${slash}*_group.h $(CLASSDIR)${slash}*$(LOAD_EXT) $(CLASSDIR)${slash}*.dump $(CLASSDIR)${slash}*.c $(CLASSDIR)${slash}*$(O)

distclean: clean
	$(RM_F) Makefile


# $Id$

# Setup some commands
LN_S          = @lns@
PERL          = @perl@
RM_F          = @rm_f@
PARROT        = ../../parrot@exe@
TOOL_DIR      = ../..
CC            = @cc@
CP            = @cp@
BUILD         = $(PERL) @build_dir@/tools/build/dynpmc.pl
O             = @o@
EXE           = @exe@
BUILD_DIR     = @build_dir@
RECONFIGURE   = $(PERL) @build_dir@/tools/dev/reconfigure.pl

LIBPARROT     = @build_dir@/libparrot@a@

CC_INC        = -I../../include
C_LIBS        = @libs@
CC_SHARED     = @cc_shared@
CFLAGS        = $(CC_INC) @ccflags@ @cc_debug@ @ccwarn@ @cc_hasjit@ @cg_flag@ @gc_flag@ $(CC_SHARED)
LINK_DYNAMIC  =  @link_dynamic@
LINK          = @link@
LINKFLAGS     = @linkflags@ @link_debug@ @ld_debug@
LD            = @ld@
LDFLAGS       = @ldflags@ @ld_debug@

SOURCES       = new/main.c \
new/pirparser.c \
new/pirlexer.c \
new/pircompunit.c \
new/pircompiler.c \
new/pirsymbol.c \
new/piremit.c

# the default target
all: pirc heredoc macro


pirc: new/main$(O) new/pirparser$(O) new/pirlexer$(O) new/pircompunit$(O) new/pircompiler$(O) new/pirsymbol$(O) new/piremit$(O)
	$(LINK) main$(O) pirparser$(O) pirlexer$(O) pircompunit$(O) pircompiler$(O) pirsymbol$(O) piremit$(O) $(LIBPARROT)

new/main$(O): new/main.c
	$(CC) $(CFLAGS) -c new/main.c

new/pirparser$(O): new/pirparser.c new/pirparser.h
	$(CC) $(CFLAGS) -c new/pirparser.c

new/pirlexer$(O): new/pirlexer.c src/pirlexer.h
	$(CC) $(CFLAGS) -c new/pirlexer.c

new/pircompunit$(O): new/pircompunit.c new/pircompunit.h
	$(CC) $(CFLAGS) -c new/pircompunit.c

new/pircompiler$(O): new/pircompiler.c new/pircompiler.h
	$(CC) $(CFLAGS) -c new/pircompiler.c

new/pirsymbol$(O): new/pirsymbol.c new/pirsymbol.h
	$(CC) $(CFLAGS) -c new/pirsymbol.c

new/piremit$(O): new/piremit.c new/piremit.h
	$(CC) $(CFLAGS) -c new/piremit.c


heredoc: heredoc/hdocprep$(O)
	$(LINK) hdocprep$(O)

heredoc/hdocprep$(O): heredoc/hdocprep.c
	$(CC) $(CFLAGS) -c heredoc/hdocprep.c

macro: macro/macroparser$(O) macro/macrolexer$(O)
	$(LINK) macroparser$(O) macrolexer$(O) $(LIBPARROT)

macro/macroparser$(O): macro/macroparser.c
	$(CC) $(CFLAGS) -c macro/macroparser.c

macro/macrolexer$(O): macro/macrolexer.c
	$(CC) $(CFLAGS) -c macro/macrolexer.c


docs: src/pirlexer.c src/pirparser.c doc/design.pod
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pirlexer.c > doc/pirlexer.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pirparser.c > doc/pirparser.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pirvtable.c > doc/pirvtable.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pirout.c > doc/pirout.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/jsonout.c > doc/jsonout.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pastout.c > doc/pastout.html
	pod2html --css=http://www.parrotcode.org/css/perl.css src/pirutil.c > doc/pirutil.html
	pod2html --css=http://www.parrotcode.org/css/perl.css doc/design.pod > doc/design.html
	pod2html --css=http://www.parrotcode.org/css/perl.css README.pod > doc/README.html

test: all
	cd t && prove && cd ..
	podchecker $(SOURCES) \
	doc/design.pod \
	README.pod

# regenerate the Makefile
Makefile: $(BUILD_DIR)/config/gen/makefiles/pirc.in
	cd $(BUILD_DIR) && $(RECONFIGURE) --step=gen::makefiles --target=compilers/pirc/Makefile


clean:
	$(RM_F) *$(O)

realclean: clean
	$(RM_F) \
Makefile \
pirc$(EXE) \
doc/*.html

distclean: realclean

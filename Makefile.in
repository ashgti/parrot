O = ${o}
RM_F = ${rm_f}

INC=include/parrot
H_FILES = $(INC)/config.h $(INC)/exceptions.h $(INC)/io.h $(INC)/op.h $(INC)/register.h $(INC)/string.h $(INC)/events.h $(INC)/interpreter.h $(INC)/memory.h $(INC)/parrot.h $(INC)/stacks.h $(INC)/packfile.h $(INC)/global_setup.h $(INC)/vtable.h

O_FILES = global_setup$(O) interpreter$(O) parrot$(O) register$(O) basic_opcodes$(O) memory$(O) packfile$(O) string$(O) strnative$(O) strutf8$(O) strutf16$(O) strutf32$(O) transcode$(O)

#DO NOT ADD C COMPILER FLAGS HERE
#Add them in Configure.pl--look for the
#comment 'ADD C COMPILER FLAGS HERE'
CFLAGS = ${ccflags} ${cc_debug}

C_LIBS = ${libs}

CC = ${cc}
LD = ${ld}
PERL = ${perl}
TEST_PROG = test_prog${exe}
PDUMP = pdump${exe}

.c$(O):
	$(CC) $(CFLAGS) -o $@ -c $<

all : $(TEST_PROG) $(PDUMP)

#XXX This target is not portable to Win32
shared: libparrot.so
libparrot.so: $(O_FILES)
	$(CC) -shared $(C_LIBS) -o $@ $(O_FILES)

$(TEST_PROG): test_main$(O) $(O_FILES) interp_guts$(O) op_info$(O)
	$(CC) $(CFLAGS) -o $(TEST_PROG) $(O_FILES) interp_guts$(O) op_info$(O) test_main$(O) $(C_LIBS)
	
$(PDUMP): pdump$(O) packfile$(O) memory$(O) global_setup$(O) string$(O) strnative$(O) strutf8$(O) strutf16$(O) strutf32$(O) transcode$(O)
	$(CC) $(CFLAGS) -o $(PDUMP) pdump$(O) packfile$(O) memory$(O) global_setup$(O) string$(O) strnative$(O) strutf8$(O) strutf16$(O) strutf32$(O) transcode$(O) $(C_LIBS)

test_main$(O): $(H_FILES) $(INC)/interp_guts.h

global_setup$(O): $(H_FILES)

string$(O): $(H_FILES)

strnative$(O): $(H_FILES)

strutf8$(O): $(H_FILES)

strutf16$(O): $(H_FILES)

strutf32$(O): $(H_FILES)

transcode$(O): $(H_FILES)

$(INC)/interp_guts.h interp_guts.c $(INC)/op_info.h op_info.c: opcode_table build_interp_starter.pl
	$(PERL) build_interp_starter.pl

interpreter$(O): interpreter.c $(H_FILES) $(INC)/interp_guts.h

memory$(O): $(H_FILES)

packfile$(O): $(H_FILES)

parrot$(O): $(H_FILES)

register$(O): $(H_FILES)

basic_opcodes$(O): $(H_FILES) basic_opcodes.c

basic_opcodes.c: basic_opcodes.ops process_opfunc.pl $(INC)/interp_guts.h
	$(PERL) process_opfunc.pl basic_opcodes.ops

$(INC)/op.h: opcode_table make_op_header.pl
	$(PERL) make_op_header.pl opcode_table > $(INC)/op.h

$(INC)/config.h: Configure.pl config_h.in
	$(PERL) Configure.pl

$(INC)/vtable.h: vtable.tbl vtable_h.pl
	$(PERL) vtable_h.pl

docs: docs/.dummy

docs/.dummy:
	cd docs; make

clean:
	$(RM_F) *$(O) *.s basic_opcodes.c interp_guts.c $(INC)/interp_guts.h $(INC)/op.h op_info.c $(INC)op_info.h $(TEST_PROG) $(PDISASM) $(PDUMP)
	$(RM_F) *$(O) *.s basic_opcodes.c $(INC)/interp_guts.h $(INC)/op.h $(TEST_PROG)
	cd docs; make clean

test:	.test_dummy

.test_dummy:
	$(PERL) t/harness

update:
	cvs -q update -dP

# Setup some commands
LN_S     = @lns@
PERL     = @perl@
RM_F     = @rm_f@
PARROT   = ..@slash@..@slash@parrot@exe@
PGE_DIR  = ..@slash@..@slash@compilers@slash@pge
TGE_DIR  = ..@slash@..@slash@compilers@slash@tge
CP       = @cp@

all: APL.pbc

SOURCES = APL.pir \
  lib/APLGrammar.pir \
  lib/pge2past.pir \
  lib/pasteval.pir \
  lib/PAST.pir \
  lib/APLFunctions.pir

APL.pbc: $(PARROT) $(SOURCES) 
	$(PARROT) --output=APL.pbc APL.pir

interactive: APL.pbc
	$(PARROT) APL.pbc

.SUFFIXES : .pir .pbc .tge .pge

.pir.pbc :
	$(PARROT) -o $@ $<

.tge.pir :
	$(PARROT) $(TGE_DIR)@slash@tgc.pir --output=$@ $<

.pge.pir :
	$(PARROT) $(PGE_DIR)@slash@rulec.pir --encoding=utf8 --compiler=p6rules --output=$@ $<

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all:               APL.pbc"
	@echo "                     This is the default."
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  devtest:           Run the test suite, using TODO not SKIP"
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'"
	@echo "  distclean:         Removes also anything built, in theory"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

test: all
	$(PERL) -Ilib t@slash@harness t@slash@*.t

devtest: all
	env APLDEV=1 $(PERL) -Ilib t@slash@harness t@slash@*.t

testclean:
	$(RM_F) "t@slash@*.apl" "t@slash@*.out"

clean: testclean
	$(RM_F) \
  APL.pbc \
  lib@slash@pge2past.pir \
  lib@slash@pasteval.pir \
  lib@slash@APLGrammar.pir

realclean: clean
	$(RM_F) Makefile

distclean: realclean

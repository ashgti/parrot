# Copyright (C) 2008, The Perl Foundation.
# $Id$

#
#       Lua 5.1 VM Instructions
#
# See : A No-Frills Introduction to Lua 5.1 VM Instructions
# by Kein-Hong Man


## Loading Constants

[MOVE]
code = 0
format = AB
pir = <<PIR
    ${INS} = concat "  set ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", ${REG}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[LOADNIL]
code = 3
format = AB
pir = <<PIR
    $I0 = ${A}
  L1_${CUROP}:
    unless $I0 <= ${B} goto L2_${CUROP}
    ${INS} = concat "  new ${REG}"
    $S0 = $I0
    ${INS} = concat $S0
    ${INS} = concat ", 'LuaNil'\n"
    inc $I0
    goto L1_${CUROP}
  L2_${CUROP}:
PIR

[LOADK]
code = 1
format = ABx
pir = <<PIR
    ${INS} = concat "  set ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", ${K}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[LOADBOOL]
code = 2
format = ABC
pir = <<PIR
    ${INS} = concat "  new ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", 'LuaBoolean'\n"
    ${INS} = concat "  set ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", "
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "\n"
    unless ${C} goto L1_${CUROP}
    $I0 = ${NEXTPC}
    inc $I0
    $S0 = $I0
    ${INS} = concat "  goto PC"
    ${INS} = concat $S0
    ${INS} = concat "\n"
  L1_${CUROP}:
PIR

## Upvalues and Globals

[GETUPVAL]
code = 4
format = AB
pir = <<PIR
PIR

[GETGLOBAL]
code = 5
format = ABx
pir = <<PIR
    ${INS} = concat "  ${GLOB} = ${SUBR}.'getfenv'()\n"
    ${INS} = concat "  ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat " = ${GLOB}[${K}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "]\n"
PIR

[SETGLOBAL]
code = 7
format = ABx
pir = <<PIR
    ${INS} = concat "  ${GLOB} = ${SUBR}.'getfenv'()\n"
    ${INS} = concat "  ${GLOB}[${K}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "] = "
    ${INS} = concat "  ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[SETUPVAL]
code = 8
format = AB
pir = <<PIR
PIR

## Table Instructions

[GETTABLE]
code = 6
format = ABC
pir = <<PIR
    ${INS} = concat "  ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat " = ${REG}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "["
    $I0 = ${C} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat "${K}"
    ${C} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat "${REG}"
  L2_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "]\n"
PIR

[SETTABLE]
code = 9
format = ABC
pir = <<PIR
    ${INS} = concat "  ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat "["
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat "${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat "${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "] = "
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat "${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat "${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

## Arithmetic and String Instructions

[ADD]
code = 12
format = ABC
pir = <<PIR
    ${INS} = concat "  add ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[SUB]
code = 13
format = ABC
pir = <<PIR
    ${INS} = concat "  sub ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[MUL]
code = 14
format = ABC
pir = <<PIR
    ${INS} = concat "  mul ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[DIV]
code = 15
format = ABC
pir = <<PIR
    ${INS} = concat "  div ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[MOD]
code = 16
format = ABC
pir = <<PIR
    ${INS} = concat "  cmod ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[POW]
code = 17
format = ABC
pir = <<PIR
    ${INS} = concat "  pow ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    $I0 = ${B} & 0x100
    unless $I0 goto L1_${CUROP}
    ${INS} = concat ", ${K}"
    ${B} &= 0xff
    goto L2_${CUROP}
  L1_${CUROP}:
    ${INS} = concat ", ${REG}"
  L2_${CUROP}:
    $S0 = ${B}
    ${INS} = concat $S0
    $I0 = ${C} & 0x100
    unless $I0 goto L3_${CUROP}
    ${INS} = concat ", ${K}"
    ${C} &= 0xff
    goto L4_${CUROP}
  L3_${CUROP}:
    ${INS} = concat ", ${REG}"
  L4_${CUROP}:
    $S0 = ${C}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[UNM]
code = 18
format = AB
pir = <<PIR
    ${INS} = concat "  neg ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", ${REG}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[NOT]
code = 19
format = AB
pir = <<PIR
    ${INS} = concat "  not ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", ${REG}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[LEN]
code = 20
format = AB
pir = <<PIR
    ${INS} = concat "  ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat " = ${REG}"
    $S0 = ${B}
    ${INS} = concat $S0
    ${INS} = concat ".'len'()\n"
PIR

[CONCAT]
code = 21
format = ABC
pir = <<PIR
    $I0 = ${B}
    inc $I0
  L1_${CUROP}:
    unless $I0 <= ${C} goto L2_${CUROP}
    ${INS} = concat "  concat ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", ${REG}"
    $S0 = $I0
    ${INS} = concat $S0
    ${INS} = concat "\n"
    inc $I0
    goto L1_${CUROP}
  L2_${CUROP}:
PIR

## Jumps and Calls

[JMP]
code = 22
format = sBx
pir = <<PIR
    $I0 = ${NEXTPC} + ${B}
    $S0 = $I0
    ${INS} = concat "  goto PC"
    ${INS} = concat $S0
    ${INS} = concat "\n"
PIR

[CALL]
code = 28
format = ABC
pir = <<PIR
PIR

[TAILCALL]
code = 29
format = ABC
pir = <<PIR
PIR

[RETURN]
code = 30
format = AB
pir = <<PIR
    ${INS} = concat "  end\n"
PIR

[VARARG]
code = 37
format = AB
pir = <<PIR
PIR

[SELF]
code = 11
format = ABC
pir = <<PIR
PIR

## Relational and Logic Instructions

[EQ]
code = 23
format = ABC
pir = <<PIR
PIR

[LT]
code = 24
format = ABC
pir = <<PIR
PIR

[LE]
code = 25
format = ABC
pir = <<PIR
PIR

[TEST]
code = 26
format = AC
pir = <<PIR
PIR

[TESTSET]
code = 27
format = ABC
pir = <<PIR
PIR

## Loop Instructions

[FORLOOP]
code = 31
format = AsBx
pir = <<PIR
PIR

[FORPREP]
code = 32
format = AsBx
pir = <<PIR
PIR

[TFORLOOP]
code = 33
format = AC
pir = <<PIR
PIR

## Table Creation

[NEWTABLE]
code = 10
format = ABC
pir = <<PIR
    ${INS} = concat "  new ${REG}"
    $S0 = ${A}
    ${INS} = concat $S0
    ${INS} = concat ", 'LuaTable'\n"
PIR

[SETLIST]
code = 34
format = ABC
pir = <<PIR
PIR

## Closures and Closing

[CLOSE]
code = 35
format = A
pir = <<PIR
PIR

[CLOSURE]
code = 36
format = ABx
pir = <<PIR
PIR


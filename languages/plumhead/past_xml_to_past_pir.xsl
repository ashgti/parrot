<?xml version='1.0'?>
<xsl:stylesheet 
  xmlns:past="http://www.parrotcode.org/PAST-0.1"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform" 
  version="1.0"
>
<!--

$Id$

This transformation takes an abstract syntax tree as generated 
by phc_xml_to_past_xml.xsl. It generates a script in PIR that creates
a Patrick Michaud PAST and runs the PAST.

-->
<xsl:output method='text' />

<xsl:template match="/" >

# Do not edit this file.                                          
# This file has been generated by past_xml_to_past_pir.xsl
                                                                  
# steal builtins from Perl6
# TODO: put that into php_builtins.pir
.sub 'print'
    .param pmc list            :slurpy
    .local pmc iter

    iter = new .Iterator, list
  iter_loop:
    unless iter goto iter_end
    $P0 = shift iter
    print $P0
    goto iter_loop
  iter_end:
    .return (1)
.end


.sub '__onload' :load :init
  load_bytecode 'PAST-pm.pbc'                                        
  load_bytecode 'MIME/Base64.pbc'              
  load_bytecode 'dumper.pbc'
.end


.sub plumhead :main                                                     
                                                                  
  # phc encodes most but not all strings in base64
  .local pmc decode_base64
  decode_base64 = get_global [ "MIME"; "Base64" ], 'decode_base64'
    
  # The root node of PAST.
  .local pmc past_node_<xsl:value-of select="generate-id(.)" />                                                  
  past_node_<xsl:value-of select="generate-id(.)" />  = new 'PAST::Block'
  past_node_<xsl:value-of select="generate-id(.)" />.init('name' => 'plumhead_main')

  <xsl:apply-templates />

  # '_dumper'(past_node_<xsl:value-of select="generate-id(.)" />, 'past')

  .local pmc eval
  eval = past_node_<xsl:value-of select="generate-id(.)" />.'compile'( )
  eval()

  # .local pmc post, pir
  # .local string pir_str
  # post = past_node_<xsl:value-of select="generate-id(.)" />.'compile'( 'target' => 'post' )
  # '_dumper'(post, 'post')
  # '_dumper'(eval, 'eval')
  # pir = past_node_<xsl:value-of select="generate-id(.)" />.'compile'( 'target' => 'pir' )
  # '_dumper'(pir, 'pir')
  # pir_str = pir
  # print pir_str
                                                                  
.end                                                              
                                                                  
</xsl:template>

<xsl:template match="past:Stmts | past:Op | past:Val | past:Var" >

  # start of generic node
  .local pmc past_node_<xsl:value-of select="generate-id(.)" />                                                  
  past_node_<xsl:value-of select="generate-id(.)" /> = new '<xsl:choose>
    <xsl:when test="name() = 'past:Exp'"   >PAST::Exp</xsl:when>
    <xsl:when test="name() = 'past:Op'"    >PAST::Op</xsl:when>
    <xsl:when test="name() = 'past:Stmt'"  >PAST::Stmt</xsl:when>
    <xsl:when test="name() = 'past:Stmts'" >PAST::Stmts</xsl:when>
    <xsl:when test="name() = 'past:Var'"   >PAST::Var</xsl:when>
                                                            </xsl:choose>'
  <xsl:apply-templates select="@*"/>
  <xsl:apply-templates />
  past_node_<xsl:value-of select="generate-id(..)" />.'push'( past_node_<xsl:value-of select="generate-id(.)" /> )      
  null past_node_<xsl:value-of select="generate-id(.)" />
  # end of generic node

</xsl:template>

<xsl:template match="past:Val">

  # start of past:Val
  <xsl:choose>
    <xsl:when test="@valtype = 'strq'" >
      .local string val_<xsl:value-of select="generate-id(.)" />
      <xsl:choose>
        <xsl:when test="@encoding = 'base64'" >
          val_<xsl:value-of select="generate-id(.)" /> = decode_base64( "<xsl:value-of select="." />" )
          val_<xsl:value-of select="generate-id(.)" /> = escape val_<xsl:value-of select="generate-id(.)" />
        </xsl:when>
        <xsl:otherwise>
          val_<xsl:value-of select="generate-id(.)" /> = "<xsl:value-of select="." />"
        </xsl:otherwise>
      </xsl:choose>
    </xsl:when>
    <xsl:when test="@valtype = 'int'" >
      .local int val_<xsl:value-of select="generate-id(.)" />
      val_<xsl:value-of select="generate-id(.)" /> = <xsl:value-of select="." />
    </xsl:when>
    <xsl:when test="@valtype = 'num'" >
      .local num val_<xsl:value-of select="generate-id(.)" />
      val_<xsl:value-of select="generate-id(.)" /> = <xsl:value-of select="." />
    </xsl:when>
  </xsl:choose>

  .local pmc past_node_<xsl:value-of select="generate-id(.)" />
  past_node_<xsl:value-of select="generate-id(.)" /> = new 'PAST::Val'                             
  <xsl:apply-templates select="@*"/>
  past_node_<xsl:value-of select="generate-id(..)" />.'push'( past_node_<xsl:value-of select="generate-id(.)" /> )      
  # end of past:Val

</xsl:template>

<!-- handle attributes -->
<xsl:template match="@*">
  past_node_<xsl:value-of select="generate-id(..)" />.'attr'( '<xsl:value-of select="name()" />', '<xsl:value-of select="." />', 1 )                              
</xsl:template>
<xsl:template match="@encoding">
   <xsl:comment>The attribute encoding is handled in PIR generation</xsl:comment>
</xsl:template>

</xsl:stylesheet>

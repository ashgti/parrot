# $Id$

# Setup some commands and pathes
PARROT   = ../../parrot@exe@
PERL     = @perl@
RM_F     = @rm_f@
PGE_DIR  = ../../compilers/pge
TGE_DIR  = ../../compilers/tge

# default
all: build

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "Building:"
	@echo "  all:               Build plumhead.pbc."
	@echo "                     This is the default."
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  test-php:          Run the test suite for the reference implementation."
	@echo "  test-phc:          Run the test suite for the Phc variant."
	@echo "  test-antlr3:       Run the test suite for the Antlr3 variant."
	@echo "  test-partridge:    Run the test suite."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             makes clean-test."
	@echo "  distclean:         makes clean-test."
	@echo "  clean-test:        Clean up temporary files from testing."
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo "Only for maintainer:"
	@echo "  maintain:          Generate runtime files with ANTLR 3"
	@echo ""

maintain: maintain-antlr3

maintain-antlr3: src/antlr3/Plumhead.g src/antlr3/GenPastPir.g
	@echo 'Be sure to set CLASSPATH first, see docs/antlr3.pod'
	java org.antlr.Tool src/antlr3/Plumhead.g
	java org.antlr.Tool -lib src/antlr3 src/antlr3/GenPastPir.g


build: build-common build-phc build-antlr3 build-partridge

build-common: src/common/plumheadlib.pbc plumhead.pbc

build-phc:
	# nothing to do

build-antlr3:
	@echo 'Be sure to have set CLASSPATH as laid out in docs/antlr3.pod'
	javac src/antlr3/*.java 

build-partridge: src/partridge/Plumhead_gen.pir src/partridge/PASTGrammar_gen.pir

src/partridge/Plumhead_gen.pir:
	$(PARROT) $(PGE_DIR)/pgc.pir --output=src/partridge/Plumhead_gen.pir src/partridge/Plumhead.pg

src/partridge/PASTGrammar_gen.pir:
	$(PARROT) $(TGE_DIR)/tgc.pir --output=src/partridge/PASTGrammar_gen.pir src/partridge/PASTGrammar.tg

src/common/plumheadlib.pbc: src/common/builtins.pir
	$(PARROT) -o src/common/plumheadlib.pbc src/common/builtins.pir

plumhead.pbc: src/common/plumhead.pir
	$(PARROT) -o plumhead.pbc src/common/plumhead.pir

test: all test-php test-phc test-antlr3 test-partridge

test-php:
	- cd .. && $(PERL) -I../lib -I plumhead/lib plumhead/t/harness --with-php

test-phc:
	- cd .. && $(PERL) -I../lib -I plumhead/lib plumhead/t/harness --with-phc

test-antlr3:
	- cd .. && $(PERL) -I../lib -I plumhead/lib plumhead/t/harness --with-antlr3

test-partridge:
	- cd .. && $(PERL) -I../lib -I plumhead/lib plumhead/t/harness --with-partridge

clean: clean-common clean-partridge clean-antlr3 clean-test

clean-common:
	$(RM_F) src/common/plumheadlib.pbc plumhead.pbc

clean-partridge:
	$(RM_F) src/partridge/Plumhead_gen.pir src/partridge/PASTGrammar_gen.pir

clean-antlr3:
	$(RM_F) src/antlr3/*.class

# Leave the generated test files in place
clean-test:

/*
Copyright: 2001-2003 The Perl Foundation.  All Rights Reserved.
$Id$

=head1 NAME

classes/coroutine.pmc - Co-Routine PMC

=head1 DESCRIPTION

C<Coroutine> extends C<Continuation> to provide a subroutine that can
stop in the middle, and start back up later at the point at which it
stopped. See the L<Glossary|docs/glossary.pod> for more information.

=head2 Flags

=over 4

=item private0 call flip flop

=item private3 called first time, used for python

=back

=head2 Methods

=over 4

=cut

*/

#include "parrot/parrot.h"
#include "parrot/method_util.h"

pmclass Coroutine extends Continuation {

/*

=item C<void init()>

Initializes the co-routine.

=cut

*/

    void init () {
        PMC_sub(SELF) = new_coroutine(INTERP);
        PMC_struct_val(SELF) = NULL;
        PObj_custom_mark_destroy_SETALL(SELF);

        if (Interp_flags_TEST(INTERP, PARROT_PYTHON_MODE))
           PObj_get_FLAGS(SELF) |= PObj_private3_FLAG;
    }

/*

=item C<void *invoke(void *next)>

Swaps the "context".

=cut

*/

    void* invoke (void* next) {
        struct Parrot_Sub * sub = (struct Parrot_Sub *)PMC_sub(SELF);
        void * dest = PMC_struct_val(SELF);
        /* python calls the coroutine initially during
         * setup
         */
        if (PObj_get_FLAGS(SELF) & PObj_private3_FLAG) {
            PMC *ret;
            /* XXX this works only once, the generated isn't reusable
             *     inside e.g. range()
             * so, return a clone of ourself
             */
            REG_PMC(5) = ret = pmc_new(INTERP, enum_class_Coroutine);
            PObj_get_FLAGS(ret) |= PObj_private1_FLAG; /* fixup done */
            PObj_get_FLAGS(ret) &= ~PObj_private3_FLAG;
            PMC_struct_val(ret) = PMC_struct_val(SELF);
            return next;
        }
        PMC_struct_val(SELF) = next;
        swap_context(interpreter, SELF);

        if (interpreter->code->cur_cs != sub->seg) {
            Parrot_switch_to_cs(interpreter, sub->seg, 1);
        }
        return dest;
    }

/*

Iterator interface

=item C<INTVAL elements ()>

Return much, we don't know.

*/

    INTVAL elements () {
        return (2^31) - 1;
    }

    PMC* get_iter () {
        return SELF;
    }

    INTVAL get_bool () {
        return 1;
    }

/*

=item C<void mark()>

Marks the coroutine as live.

=cut

*/

    void mark () {
        struct Parrot_Coroutine *c = (struct Parrot_Coroutine *)PMC_sub(SELF);
        mark_stack(INTERP, c->co_control_stack);
        mark_stack(INTERP, c->co_control_base);
        /* mark_stack(INTERP, c->co_pad_stack); */
        mark_context(INTERP, &c->ctx);
    }
}

/*

=back

=head1 HISTORY

Initial version by Melvin on 2002/06/6.

=cut

*/

/*
 * Local variables:
 * c-indentation-style: bsd
 * c-basic-offset: 4
 * indent-tabs-mode: nil
 * End:
 *
 * vim: expandtab shiftwidth=4:
*/
